<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6366f1">
    <title>An√°lisis de Actas Escolares</title>
    
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #ddd6fe 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card.recommended {
            border: 3px solid #10b981;
            position: relative;
        }

        .badge-recommended {
            position: absolute;
            top: -12px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 0.25rem 1rem;
            border-radius: 1rem;
            font-weight: bold;
            font-size: 0.875rem;
        }

        h1 {
            color: #1f2937;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        h2 {
            color: #374151;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        h3 {
            color: #4b5563;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-primary {
            background: #6366f1;
            color: white;
        }

        .btn-primary:hover {
            background: #4f46e5;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-info {
            background: #0ea5e9;
            color: white;
        }

        .btn-info:hover {
            background: #0284c7;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .option-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .option-card:hover {
            border-color: #6366f1;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .option-card.recommended {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .checkbox-item {
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            border-color: #6366f1;
        }

        .checkbox-item.selected {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .stat-box {
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .alert {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 0.5rem;
            padding: 1rem;
            color: #dc2626;
            font-weight: 600;
        }

        .comment-box {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            white-space: pre-line;
            line-height: 1.6;
        }

        .global-comment {
            background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%);
            border-left: 4px solid #6366f1;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            white-space: pre-line;
            line-height: 1.6;
        }

        .grade-badge {
            background: white;
            border: 2px solid;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }

        .grade-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .grade-count {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .grade-percent {
            font-size: 1.125rem;
            font-weight: bold;
            margin-top: 0.25rem;
        }

        .chart-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #6366f1;
            color: white;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
        }

        .file-label:hover {
            background: #4f46e5;
        }

        .back-link {
            color: #6366f1;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 1rem;
            display: inline-block;
        }

        .back-link:hover {
            color: #4f46e5;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: monospace;
        }

        .input-group textarea {
            min-height: 350px;
            resize: vertical;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #6366f1;
        }

        .help-text {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .success-box {
            background: #d1fae5;
            border: 2px solid #10b981;
            border-radius: 0.5rem;
            padding: 1rem;
            color: #065f46;
            margin-top: 1rem;
        }

        .error-box {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 0.5rem;
            padding: 1rem;
            color: #991b1b;
            margin-top: 1rem;
        }

        .info-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 1rem;
            color: #1e40af;
            margin-bottom: 1rem;
        }

        .info-box ul {
            margin-left: 1.5rem;
            margin-top: 0.5rem;
        }

        .info-box li {
            margin-bottom: 0.25rem;
        }

        @media print {
            body {
                background: white;
            }
            .btn, .back-link, .btn-group {
                display: none !important;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        const state = {
            stage: null,
            selectedCourse: null,
            uploadedFile: null,
            pdfData: null,
            subjects: [],
            selectedSubjects: [],
            statistics: null,
            globalStats: null,
            totalStudents: 21
        };

        const infantilCourses = ['3 a√±os', '4 a√±os', '5 a√±os'];
        const primariaCourses = ['1¬∫ Primaria', '2¬∫ Primaria', '3¬∫ Primaria', '4¬∫ Primaria', '5¬∫ Primaria', '6¬∫ Primaria'];
        
        // Calificaciones actualizadas
        const infantilGrades = ['NAD', 'ADE', 'BUE', 'EXC'];
        const primariaGrades = ['IN', 'SU', 'BI', 'NT', 'SB'];

        const COLORS = {
            NAD: '#ef4444', IN: '#ef4444',
            ADE: '#fbbf24', SU: '#fbbf24',
            BUE: '#60a5fa', BI: '#60a5fa',
            EXC: '#10b981', NT: '#34d399', SB: '#10b981'
        };

        // Definici√≥n de asignaturas seg√∫n curso
        function getSubjectsForCourse(stage, course) {
            if (stage === 'infantil') {
                return ['ING', 'REL', 'ATEDU', 'CA', 'DEE', 'CRR'];
            } else if (stage === 'primaria') {
                if (course === '1¬∫ Primaria' || course === '2¬∫ Primaria' || 
                    course === '3¬∫ Primaria' || course === '4¬∫ Primaria') {
                    return ['CMN', 'EAR', 'EFI', 'LCL', 'ING', 'MAT', 'REL', 'ATEDU'];
                } else if (course === '5¬∫ Primaria') {
                    return ['CMN', 'EAR', 'EFI', 'LCL', 'ING', 'MAT', 'FR2', 'ALCT', 'REL', 'REV', 'ATEDU'];
                } else if (course === '6¬∫ Primaria') {
                    return ['CMN', 'EAR', 'EFI', 'LCL', 'ING', 'MAT', 'FR2', 'VCE', 'REL', 'REV', 'ATEDU'];
                }
            }
            return [];
        }

        // Funciones para dibujar gr√°ficas
        function drawPieChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 40;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            let currentAngle = -Math.PI / 2;
            const total = data.reduce((sum, item) => sum + item.value, 0);
            
            data.forEach((item, index) => {
                const sliceAngle = (2 * Math.PI * item.value) / total;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index];
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                const midAngle = currentAngle + sliceAngle / 2;
                const labelX = centerX + Math.cos(midAngle) * (radius * 0.7);
                const labelY = centerY + Math.sin(midAngle) * (radius * 0.7);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(item.percentage + '%', labelX, labelY);
                
                currentAngle += sliceAngle;
            });
            
            let legendY = 20;
            data.forEach((item, index) => {
                ctx.fillStyle = colors[index];
                ctx.fillRect(10, legendY, 20, 20);
                ctx.fillStyle = '#374151';
                ctx.font = '14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(item.label + ': ' + item.value, 35, legendY + 15);
                legendY += 30;
            });
        }

        function drawBarChart(canvasId, data, colors) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const maxValue = Math.max(...data.map(d => d.value), 1);
            const barWidth = chartWidth / data.length * 0.7;
            const barSpacing = chartWidth / data.length;
            
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = padding + index * barSpacing + (barSpacing - barWidth) / 2;
                const y = canvas.height - padding - barHeight;
                
                ctx.fillStyle = colors[index] || '#6366f1';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.value, x + barWidth / 2, y - 5);
                
                ctx.fillText(item.label, x + barWidth / 2, canvas.height - padding + 20);
            });
            
            ctx.strokeStyle = '#9ca3af';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();
        }

        function showPasteInput() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <a href="#" class="back-link" onclick="state.uploadedFile = null; render(); return false;">‚Üê Volver</a>
                    <h1>üìã Pegar Tabla del Acta</h1>
                    
                    <div class="card">
                        <div class="info-box">
                            <strong>üìù Instrucciones:</strong>
                            <ol style="margin-left: 1.5rem; margin-top: 0.5rem; line-height: 1.8;">
                                <li><strong>Abre el PDF</strong> del acta en tu ordenador</li>
                                <li><strong>Selecciona toda la tabla</strong> con el rat√≥n (arrastra sobre la tabla)</li>
                                <li><strong>Copia</strong> con Ctrl+C (Windows) o Cmd+C (Mac)</li>
                                <li><strong>Pega aqu√≠ abajo</strong> con Ctrl+V o Cmd+V</li>
                            </ol>
                        </div>

                        <div class="input-group">
                            <label>Pega aqu√≠ el contenido de la tabla:</label>
                            <textarea id="pastedTable" placeholder="Pega aqu√≠ el texto copiado del PDF...&#10;&#10;Ejemplo:&#10;1 apellido, nombre falso NAD ADE BUE EXC&#10;2 nombre y apellido falso ADE BUE EXC NAD&#10;..."></textarea>
                            <p class="help-text">
                                üí° La aplicaci√≥n detectar√° autom√°ticamente las calificaciones
                            </p>
                        </div>

                        <button class="btn btn-success" style="width: 100%; margin-top: 1rem;" onclick="processPastedTable()">
                            Analizar Tabla
                        </button>

                        <div id="parseResult"></div>
                    </div>
                </div>
            `;
        }

        function processPastedTable() {
            const textarea = document.getElementById('pastedTable');
            const text = textarea.value;
            const resultDiv = document.getElementById('parseResult');

            if (!text.trim()) {
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>‚ö†Ô∏è No has pegado nada</strong>
                        <p>Por favor, copia la tabla del PDF y p√©gala en el √°rea de texto</p>
                    </div>
                `;
                return;
            }

            try {
                const parsed = parseTableText(text);
                
                if (parsed.success) {
                    state.pdfData = parsed.grades;
                    state.totalStudents = parsed.totalStudents;
                    state.subjects = Object.keys(parsed.grades);
                    state.uploadedFile = { name: 'pasted-table' };

                    let warningHtml = '';
                    if (parsed.warning) {
                        warningHtml = `
                            <div class="info-box" style="background: #fef3c7; border-color: #f59e0b; color: #92400e; margin-top: 1rem;">
                                <strong>‚ö†Ô∏è ${parsed.warning}</strong>
                                <p style="margin-top: 0.5rem;">Verifica que los datos sean correctos. Si hay errores, usa la opci√≥n "Introducir datos manualmente".</p>
                            </div>
                        `;
                    }

                    resultDiv.innerHTML = `
                        <div class="success-box">
                            <strong>‚úÖ Tabla procesada correctamente</strong>
                            <p><strong>${parsed.totalStudents}</strong> alumnos detectados</p>
                            <p><strong>${state.subjects.length}</strong> asignaturas encontradas: ${state.subjects.join(', ')}</p>
                        </div>
                        ${warningHtml}
                    `;

                    setTimeout(() => {
                        render();
                    }, 1500);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error-box">
                            <strong>‚ö†Ô∏è No se pudo procesar la tabla autom√°ticamente</strong>
                            <p>${parsed.error}</p>
                            <button class="btn btn-primary" onclick="showManualInput()" style="margin-top: 1rem;">
                                Introducir datos manualmente
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `
                    <div class="error-box">
                        <strong>‚ùå Error al procesar</strong>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="showManualInput()" style="margin-top: 1rem;">
                            Introducir datos manualmente
                        </button>
                    </div>
                `;
            }
        }

        function parseTableText(text) {
            const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
            const subjectCodes = getSubjectsForCourse(state.stage, state.selectedCourse);
            const expectedColumns = subjectCodes.length;

            const result = {
                success: false,
                grades: {},
                totalStudents: 0,
                error: ''
            };

            // Initialize counters
            subjectCodes.forEach(subject => {
                result.grades[subject] = {};
                grades.forEach(grade => {
                    result.grades[subject][grade] = 0;
                });
            });

            // Split lines and clean
            const lines = text.split(/\r?\n/).filter(line => line.trim());
            let studentsFound = 0;
            let inconsistentRows = 0;

            // Process each line - extract ALL grades in order
            lines.forEach(line => {
                // Find all grade matches in this line
                const gradePattern = new RegExp('\\b(' + grades.join('|') + ')\\b', 'gi');
                const matches = line.match(gradePattern);
                
                if (matches && matches.length > 0) {
                    studentsFound++;
                    
                    // Check if we have the expected number of grades
                    if (matches.length !== expectedColumns) {
                        inconsistentRows++;
                        console.warn(`Fila ${studentsFound}: Se esperaban ${expectedColumns} calificaciones, se encontraron ${matches.length}`);
                    }
                    
                    // Assign grades to subjects by position (even if incomplete)
                    matches.forEach((grade, colIndex) => {
                        if (colIndex < subjectCodes.length) {
                            result.grades[subjectCodes[colIndex]][grade.toUpperCase()]++;
                        }
                    });
                }
            });

            if (studentsFound === 0) {
                result.error = 'No se detectaron alumnos. Copia toda la tabla del PDF.';
                return result;
            }

            // Verify we have valid data
            let hasValidData = false;
            subjectCodes.forEach(subject => {
                const total = Object.values(result.grades[subject]).reduce((sum, val) => sum + val, 0);
                if (total > 0) hasValidData = true;
            });

            if (!hasValidData) {
                result.error = 'No se detectaron calificaciones v√°lidas.';
                return result;
            }

            // Warn if there were inconsistent rows
            if (inconsistentRows > 0) {
                result.warning = `Atenci√≥n: ${inconsistentRows} filas tienen un n√∫mero de calificaciones diferente al esperado. Revisa los resultados.`;
            }

            result.totalStudents = studentsFound;
            result.success = true;

            return result;
        }

        function showManualInput() {
            const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
            const subjects = getSubjectsForCourse(state.stage, state.selectedCourse);
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="container">
                    <a href="#" class="back-link" onclick="state.uploadedFile = null; render(); return false;">‚Üê Volver</a>
                    <h1>‚úèÔ∏è Introducir Datos Manualmente</h1>
                    
                    <div class="card">
                        <div class="input-group">
                            <label>N√∫mero total de alumnos:</label>
                            <input type="number" id="totalStudents" value="${state.totalStudents}" min="1" max="100">
                        </div>

                        <h3>Introduce las calificaciones por asignatura</h3>
                        <p class="help-text">Para cada asignatura, indica cu√°ntos alumnos tienen cada calificaci√≥n</p>
                        
                        <div id="manualInputFields"></div>
                        
                        <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" onclick="processManualData()">
                            Procesar Datos
                        </button>
                    </div>
                </div>
            `;

            const fieldsContainer = document.getElementById('manualInputFields');
            subjects.forEach((subject, idx) => {
                const existingData = state.pdfData && state.pdfData[subject] ? state.pdfData[subject] : {};
                
                fieldsContainer.innerHTML += `
                    <div class="card" style="background: #f9fafb; margin-top: 1rem;">
                        <h3>${subject}</h3>
                        <div class="grid-3" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                            ${grades.map(grade => `
                                <div class="input-group">
                                    <label>${grade}:</label>
                                    <input type="number" id="${subject}-${grade}" value="${existingData[grade] || 0}" min="0">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
        }

        function processManualData() {
            const totalStudents = parseInt(document.getElementById('totalStudents').value);
            state.totalStudents = totalStudents;
            
            const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
            const subjects = getSubjectsForCourse(state.stage, state.selectedCourse);
            
            const manualData = {};
            subjects.forEach(subject => {
                manualData[subject] = {};
                grades.forEach(grade => {
                    const inputId = `${subject}-${grade}`;
                    const input = document.getElementById(inputId);
                    manualData[subject][grade] = parseInt(input.value) || 0;
                });
            });
            
            state.pdfData = manualData;
            state.subjects = subjects;
            state.uploadedFile = { name: 'manual-input' };
            render();
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.stage) {
                app.innerHTML = `
                    <div class="container">
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">
                                Sistema de An√°lisis de Actas Escolares
                            </h1>
                            <p style="color: #6b7280; font-size: 1.125rem;">
                                An√°lisis estad√≠stico de resultados acad√©micos
                            </p>
                        </div>
                        
                        <div class="grid-2">
                            <div class="option-card" onclick="selectStage('infantil')">
                                <div class="emoji">üé®</div>
                                <h2>Infantil</h2>
                                <p style="color: #6b7280;">3 a√±os, 4 a√±os, 5 a√±os</p>
                            </div>
                            
                            <div class="option-card" onclick="selectStage('primaria')">
                                <div class="emoji">üìö</div>
                                <h2>Primaria</h2>
                                <p style="color: #6b7280;">1¬∫ a 6¬∫ de Primaria</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!state.selectedCourse) {
                const courses = state.stage === 'infantil' ? infantilCourses : primariaCourses;
                app.innerHTML = `
                    <div class="container">
                        <a href="#" class="back-link" onclick="resetAll(); return false;">‚Üê Volver al inicio</a>
                        
                        <div style="text-align: center; margin-bottom: 3rem;">
                            <h1>${state.stage === 'infantil' ? 'Educaci√≥n Infantil' : 'Educaci√≥n Primaria'}</h1>
                            <p style="color: #6b7280;">Selecciona el curso a analizar</p>
                        </div>
                        
                        <div class="grid-3">
                            ${courses.map(course => `
                                <div class="option-card" onclick="selectCourse('${course}')">
                                    <h3>${course}</h3>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (!state.uploadedFile) {
                app.innerHTML = `
                    <div class="container">
                        <a href="#" class="back-link" onclick="state.selectedCourse = null; render(); return false;">‚Üê Cambiar curso</a>
                        <h1>${state.stage === 'infantil' ? 'Infantil' : 'Primaria'} - ${state.selectedCourse}</h1>
                        
                        <div class="card">
                            <h2 style="text-align: center; margin-bottom: 2rem;">¬øC√≥mo quieres introducir los datos?</h2>
                            
                            <div class="grid-3">
                                <div class="option-card recommended" onclick="showPasteInput()">
                                    <span class="badge-recommended">‚≠ê Recomendado</span>
                                    <div class="emoji">üìã</div>
                                    <h3>Pegar tabla</h3>
                                    <p style="color: #065f46; font-size: 0.9rem; font-weight: 600;">M√°s r√°pido y preciso</p>
                                </div>
                                
                                <div class="option-card" onclick="showManualInput()">
                                    <div class="emoji">‚úèÔ∏è</div>
                                    <h3>Manual</h3>
                                    <p style="color: #6b7280; font-size: 0.9rem;">Introduce dato a dato</p>
                                </div>
                                
                                <div class="option-card" onclick="alert('Pr√≥ximamente disponible')">
                                    <div class="emoji">üìÑ</div>
                                    <h3>Subir PDF</h3>
                                    <p style="color: #6b7280; font-size: 0.9rem;">Pr√≥ximamente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (!state.statistics) {
                app.innerHTML = `
                    <div class="container">
                        <a href="#" class="back-link" onclick="state.selectedCourse = null; state.uploadedFile = null; render(); return false;">‚Üê Cambiar m√©todo</a>
                        <h1>${state.stage === 'infantil' ? 'Infantil' : 'Primaria'} - ${state.selectedCourse}</h1>
                        
                        <div class="card">
                            <h2>üìã Seleccionar Asignaturas para An√°lisis</h2>
                            
                            <div class="grid-3">
                                ${state.subjects.map(subject => `
                                    <div class="checkbox-item ${state.selectedSubjects.includes(subject) ? 'selected' : ''}" 
                                         onclick="toggleSubject('${subject}')">
                                        <input type="checkbox" ${state.selectedSubjects.includes(subject) ? 'checked' : ''} 
                                               onchange="event.stopPropagation()">
                                        <span>${subject}</span>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;" 
                                    onclick="generateStatistics()" 
                                    ${state.selectedSubjects.length === 0 ? 'disabled' : ''}>
                                Generar Estad√≠sticas (${state.selectedSubjects.length} asignaturas)
                            </button>
                        </div>
                    </div>
                `;
            } else {
                renderStatistics();
            }
        }

        function renderStatistics() {
            const app = document.getElementById('app');
            
            let html = `
                <div class="container">
                    <div class="flex-between">
                        <h1>üìä Resultados del An√°lisis</h1>
                        <div class="btn-group">
                            <button class="btn btn-warning" onclick="downloadPDFWithCharts()">
                                üñ®Ô∏è PDF con Gr√°ficas
                            </button>
                            <button class="btn btn-success" onclick="downloadPDF()">
                                üíæ PDF Texto
                            </button>
                            <button class="btn btn-info" onclick="downloadExcel()">
                                üìä Excel
                            </button>
                            <button class="btn btn-primary" onclick="state.statistics = null; state.globalStats = null; state.selectedSubjects = []; render();">
                                Nuevo An√°lisis
                            </button>
                        </div>
                    </div>

                    <div class="card" id="results-container">
                        <h2>Resumen General</h2>
                        <div class="grid-3">
                            <div class="stat-box" style="background: #dbeafe;">
                                <div class="stat-label">Total Alumnos</div>
                                <div class="stat-value">${state.totalStudents}</div>
                            </div>
                            <div class="stat-box" style="background: #d1fae5;">
                                <div class="stat-label">Asignaturas Analizadas</div>
                                <div class="stat-value">${state.statistics.length}</div>
                            </div>
                            <div class="stat-box" style="background: #fef3c7;">
                                <div class="stat-label">Alertas</div>
                                <div class="stat-value" style="color: #dc2626;">${state.statistics.filter(s => s.alert).length}</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üìä Estad√≠sticas Globales</h2>
                        
                        <div class="grid-2">
                            <div>
                                <h3 style="text-align: center;">Aprobados vs Suspensos</h3>
                                <div class="chart-container">
                                    <canvas id="globalPieChart" width="400" height="300"></canvas>
                                </div>
                            </div>
                            <div>
                                <h3 style="text-align: center;">Distribuci√≥n de Calificaciones</h3>
                                <div class="chart-container">
                                    <canvas id="globalBarChart" width="400" height="300"></canvas>
                                </div>
                            </div>
                        </div>

                        <h3>Detalle por Calificaci√≥n</h3>
                        <div class="grid-3" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                            ${Object.entries(state.globalStats.gradePercentages).map(([grade, percentage]) => `
                                <div class="grade-badge" style="border-color: ${COLORS[grade]};">
                                    <div class="grade-name" style="color: ${COLORS[grade]};">${grade}</div>
                                    <div class="grade-count">${state.globalStats.gradeDistribution[grade]} calif.</div>
                                    <div class="grade-percent">${percentage}%</div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                            <strong>Totales:</strong> 
                            <span style="color: #10b981;">‚úì Aprobados: ${state.globalStats.passPercentage}%</span> | 
                            <span style="color: #ef4444;">‚úó Suspensos: ${state.globalStats.failPercentage}%</span>
                        </div>

                        <div class="global-comment">
                            ${state.globalStats.comment}
                        </div>
                    </div>

                    ${state.statistics.map((stat, idx) => `
                        <div class="card">
                            <div class="flex-between">
                                <h2>${stat.subject}</h2>
                                ${stat.alert ? `
                                    <div class="alert">
                                        ‚ö†Ô∏è M√°s del 30% de suspensos (${stat.failPercentage}%)
                                    </div>
                                ` : ''}
                            </div>

                            <div style="margin: 1rem 0; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem;">
                                <strong>Resumen:</strong> 
                                <span style="color: #10b981;">‚úì ${stat.passPercentage}% aprobados</span> | 
                                <span style="color: #ef4444;">‚úó ${stat.failPercentage}% suspensos</span>
                            </div>

                            <div class="grid-2">
                                <div>
                                    <h3 style="text-align: center;">Distribuci√≥n</h3>
                                    <div class="chart-container">
                                        <canvas id="pieChart${idx}" width="400" height="300"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <h3 style="text-align: center;">Por Calificaci√≥n</h3>
                                    <div class="chart-container">
                                        <canvas id="barChart${idx}" width="400" height="300"></canvas>
                                    </div>
                                </div>
                            </div>

                            <h3>Detalle de Calificaciones</h3>
                            <div class="grid-3" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                                ${Object.entries(stat.gradePercentages).map(([grade, percentage]) => `
                                    <div class="grade-badge" style="border-color: ${COLORS[grade]};">
                                        <div class="grade-name" style="color: ${COLORS[grade]};">${grade}</div>
                                        <div class="grade-count">${stat.gradeDistribution[grade]} alumnos</div>
                                        <div class="grade-percent">${percentage}%</div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="comment-box">
                                ${stat.comment}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            app.innerHTML = html;
            
            setTimeout(() => {
                drawGlobalCharts();
                state.statistics.forEach((stat, idx) => drawSubjectCharts(stat, idx));
            }, 100);
        }

        function drawGlobalCharts() {
            const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
            const failGrade = grades[0];
            
            const pieData = [
                {
                    label: 'Aprobados',
                    value: state.globalStats.passed,
                    percentage: state.globalStats.passPercentage
                },
                {
                    label: 'Suspensos',
                    value: state.globalStats.failed,
                    percentage: state.globalStats.failPercentage
                }
            ];
            drawPieChart('globalPieChart', pieData, ['#10b981', '#ef4444']);
            
            const barData = grades.map(grade => ({
                label: grade,
                value: state.globalStats.gradeDistribution[grade]
            }));
            const barColors = grades.map(grade => COLORS[grade]);
            drawBarChart('globalBarChart', barData, barColors);
        }

        function drawSubjectCharts(stat, idx) {
            const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
            const failGrade = grades[0];
            
            const pieData = [
                {
                    label: 'Aprobados',
                    value: stat.passed,
                    percentage: stat.passPercentage
                },
                {
                    label: 'Suspensos',
                    value: stat.failed,
                    percentage: stat.failPercentage
                }
            ];
            drawPieChart(`pieChart${idx}`, pieData, ['#10b981', '#ef4444']);
            
            const barData = grades.map(grade => ({
                label: grade,
                value: stat.gradeDistribution[grade]
            }));
            const barColors = grades.map(grade => COLORS[grade]);
            drawBarChart(`barChart${idx}`, barData, barColors);
        }

        function selectStage(stage) {
            state.stage = stage;
            render();
        }

        function selectCourse(course) {
            state.selectedCourse = course;
            render();
        }

        function resetAll() {
            state.stage = null;
            state.selectedCourse = null;
            state.uploadedFile = null;
            state.pdfData = null;
            state.subjects = [];
            state.selectedSubjects = [];
            state.statistics = null;
            state.globalStats = null;
            render();
        }

        function toggleSubject(subject) {
            const index = state.selectedSubjects.indexOf(subject);
            if (index > -1) {
                state.selectedSubjects.splice(index, 1);
            } else {
                state.selectedSubjects.push(subject);
            }
            render();
        }

        function generateGlobalComment(globalStats, stage) {
            const grades = stage === 'infantil' ? infantilGrades : primariaGrades;
            const passPercentage = parseFloat(globalStats.passPercentage);
            const failPercentage = parseFloat(globalStats.failPercentage);
            
            let comment = 'üìä AN√ÅLISIS GLOBAL DEL CURSO\n\n';
            
            if (passPercentage >= 90) {
                comment += 'üåü Rendimiento Sobresaliente: El curso muestra resultados excepcionales con un ' + passPercentage + '% de aprobados.\n\n';
            } else if (passPercentage >= 75) {
                comment += '‚úÖ Buen Rendimiento: El curso presenta buenos resultados acad√©micos con un ' + passPercentage + '% de aprobados.\n\n';
            } else if (passPercentage >= 60) {
                comment += '‚ö° Rendimiento Aceptable: El curso mantiene un nivel aceptable con un ' + passPercentage + '% de aprobados, aunque hay margen de mejora.\n\n';
            } else {
                comment += '‚ö†Ô∏è Rendimiento Preocupante: Se detecta un bajo porcentaje de aprobados (' + passPercentage + '%), se recomienda intervenci√≥n pedag√≥gica.\n\n';
            }
            
            comment += 'üìã Distribuci√≥n de Calificaciones:\n';
            grades.forEach(grade => {
                const percentage = globalStats.gradePercentages[grade];
                const count = globalStats.gradeDistribution[grade];
                comment += `   ‚Ä¢ ${grade}: ${count} calificaciones (${percentage}%)\n`;
            });
            
            comment += '\nüí° Observaciones:\n';
            
            if (failPercentage > 30) {
                comment += '   ‚Ä¢ Alto porcentaje de suspensos (' + failPercentage + '%) - Se sugiere refuerzo educativo urgente\n';
            } else if (failPercentage > 15) {
                comment += '   ‚Ä¢ Porcentaje moderado de suspensos (' + failPercentage + '%) - Considerar apoyos adicionales\n';
            } else if (failPercentage > 0) {
                comment += '   ‚Ä¢ Bajo porcentaje de suspensos (' + failPercentage + '%) - Dentro de par√°metros normales\n';
            } else {
                comment += '   ‚Ä¢ Sin suspensos - Rendimiento excepcional del grupo\n';
            }
            
            const topGrade = grades[grades.length - 1];
            const topPercentage = parseFloat(globalStats.gradePercentages[topGrade]);
            if (topPercentage > 40) {
                comment += `   ‚Ä¢ Excelente concentraci√≥n en calificaciones altas (${topGrade}: ${topPercentage}%)\n`;
            }
            
            return comment;
        }

        function generateSubjectComment(stat, stage) {
            const grades = stage === 'infantil' ? infantilGrades : primariaGrades;
            const passPercentage = parseFloat(stat.passPercentage);
            const failPercentage = parseFloat(stat.failPercentage);
            
            let comment = '';
            
            if (passPercentage >= 90) {
                comment += '‚úÖ Excelentes resultados en esta asignatura. ';
            } else if (passPercentage >= 75) {
                comment += '‚úì Buenos resultados generales. ';
            } else if (passPercentage >= 60) {
                comment += '‚ö° Resultados aceptables pero mejorables. ';
            } else {
                comment += '‚ö†Ô∏è Resultados preocupantes que requieren atenci√≥n. ';
            }
            
            if (stat.alert) {
                comment += '\n\nüö® ALERTA: M√°s del 30% de suspensos (' + failPercentage + '%). ';
                comment += 'Se recomienda:\n';
                comment += '   ‚Ä¢ Revisi√≥n de metodolog√≠a de ense√±anza\n';
                comment += '   ‚Ä¢ Refuerzo educativo individualizado\n';
                comment += '   ‚Ä¢ Coordinaci√≥n con el equipo docente\n';
            }
            
            const topGrade = grades[grades.length - 1];
            const topPercentage = parseFloat(stat.gradePercentages[topGrade]);
            
            if (topPercentage > 50) {
                comment += `\n\nüåü Destacable: ${topPercentage}% de los alumnos obtiene la m√°xima calificaci√≥n (${topGrade}).`;
            } else if (topPercentage > 30) {
                comment += `\n\nüëç Positivo: ${topPercentage}% alcanza la m√°xima calificaci√≥n (${topGrade}).`;
            }
            
            comment += '\n\nDistribuci√≥n: ';
            const distribution = grades.map(grade => 
                `${grade} ${stat.gradePercentages[grade]}%`
            ).join(' | ');
            comment += distribution;
            
            return comment;
        }

        function generateStatistics() {
            const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
            const failGrade = grades[0];
            
            const stats = state.selectedSubjects.map(subject => {
                const subjectData = state.pdfData[subject];
                
                const gradeDistribution = {};
                grades.forEach(grade => {
                    gradeDistribution[grade] = subjectData[grade] || 0;
                });
                
                const failed = gradeDistribution[failGrade];
                const total = Object.values(gradeDistribution).reduce((sum, val) => sum + val, 0);
                const passed = total - failed;
                
                const passPercentage = total > 0 ? ((passed / total) * 100).toFixed(1) : '0.0';
                const failPercentage = total > 0 ? ((failed / total) * 100).toFixed(1) : '0.0';
                
                const gradePercentages = {};
                grades.forEach(grade => {
                    gradePercentages[grade] = total > 0 ? ((gradeDistribution[grade] / total) * 100).toFixed(1) : '0.0';
                });
                
                const stat = {
                    subject,
                    gradeDistribution,
                    gradePercentages,
                    passed,
                    failed,
                    passPercentage,
                    failPercentage,
                    alert: parseFloat(failPercentage) > 30
                };
                
                stat.comment = generateSubjectComment(stat, state.stage);
                
                return stat;
            });

            state.statistics = stats;

            const globalGradeDistribution = {};
            grades.forEach(grade => {
                globalGradeDistribution[grade] = 0;
            });

            let totalGrades = 0;
            stats.forEach(stat => {
                Object.entries(stat.gradeDistribution).forEach(([grade, count]) => {
                    globalGradeDistribution[grade] += count;
                    totalGrades += count;
                });
            });

            const globalGradePercentages = {};
            Object.entries(globalGradeDistribution).forEach(([grade, count]) => {
                globalGradePercentages[grade] = totalGrades > 0 ? ((count / totalGrades) * 100).toFixed(1) : '0.0';
            });

            const totalFailed = globalGradeDistribution[failGrade];
            const totalPassed = totalGrades - totalFailed;

            state.globalStats = {
                totalGrades,
                gradeDistribution: globalGradeDistribution,
                gradePercentages: globalGradePercentages,
                passed: totalPassed,
                failed: totalFailed,
                passPercentage: totalGrades > 0 ? ((totalPassed / totalGrades) * 100).toFixed(1) : '0.0',
                failPercentage: totalGrades > 0 ? ((totalFailed / totalGrades) * 100).toFixed(1) : '0.0'
            };

            state.globalStats.comment = generateGlobalComment(state.globalStats, state.stage);

            render();
        }

        function cleanText(text) {
            return text.replace(/[‚ö†‚úÖ‚ö°üåüüìùüìãüìäüíæüé®üìöüì§üì∑‚úèÔ∏èüìÑ‚úì‚úóüö®üëçüí°]/g, '').trim();
        }

        function downloadPDFWithCharts() {
            // Mostrar indicador de carga
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'pdfLoading';
            loadingDiv.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(99, 102, 241, 0.95); display: flex; 
                flex-direction: column; align-items: center; justify-content: center; 
                z-index: 9999; color: white;
            `;
            loadingDiv.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                <div style="font-size: 1.5rem; font-weight: bold;">Generando PDF con gr√°ficas...</div>
                <div style="font-size: 1rem; margin-top: 0.5rem;">Esto puede tardar unos segundos</div>
            `;
            document.body.appendChild(loadingDiv);
            
            setTimeout(() => {
                try {
                    generatePDFWithCharts();
                    document.body.removeChild(loadingDiv);
                } catch (error) {
                    document.body.removeChild(loadingDiv);
                    console.error('Error:', error);
                    alert('Error al generar PDF con gr√°ficas. Intenta usar el PDF de texto.');
                }
            }, 100);
        }

        function generatePDFWithCharts() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                // T√≠tulo
                pdf.setFontSize(18);
                pdf.setTextColor(99, 102, 241);
                pdf.text('INFORME DE ANALISIS DE ACTAS', pageWidth / 2, 20, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`${state.stage === 'infantil' ? 'Infantil' : 'Primaria'} - ${state.selectedCourse}`, pageWidth / 2, 28, { align: 'center' });
                pdf.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, pageWidth / 2, 35, { align: 'center' });
                
                let y = 48;

                // Resumen general
                pdf.setFontSize(14);
                pdf.setTextColor(99, 102, 241);
                pdf.text('RESUMEN GENERAL', 20, y);
                y += 8;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Total de alumnos: ${state.totalStudents}`, 20, y);
                y += 6;
                pdf.text(`Asignaturas analizadas: ${state.statistics.length}`, 20, y);
                y += 6;
                pdf.text(`Alertas detectadas: ${state.statistics.filter(s => s.alert).length}`, 20, y);
                y += 15;

                // Gr√°ficas globales
                pdf.setFontSize(14);
                pdf.setTextColor(99, 102, 241);
                pdf.text('GRAFICAS GLOBALES', 20, y);
                y += 8;

                const globalPieCanvas = document.getElementById('globalPieChart');
                const globalBarCanvas = document.getElementById('globalBarChart');
                
                if (globalPieCanvas) {
                    const pieImg = globalPieCanvas.toDataURL('image/png');
                    pdf.addImage(pieImg, 'PNG', 20, y, 80, 60);
                }
                
                if (globalBarCanvas) {
                    const barImg = globalBarCanvas.toDataURL('image/png');
                    pdf.addImage(barImg, 'PNG', 110, y, 80, 60);
                }
                
                y += 70;

                // Estad√≠sticas globales
                const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
                pdf.setFontSize(12);
                pdf.text(`Aprobados: ${state.globalStats.passPercentage}% | Suspensos: ${state.globalStats.failPercentage}%`, 20, y);
                y += 8;

                pdf.setFontSize(10);
                pdf.text('Distribucion por calificacion:', 20, y);
                y += 6;
                grades.forEach(grade => {
                    pdf.text(`  ${grade}: ${state.globalStats.gradeDistribution[grade]} (${state.globalStats.gradePercentages[grade]}%)`, 20, y);
                    y += 5;
                });
                y += 5;

                const globalComment = cleanText(state.globalStats.comment);
                const globalLines = pdf.splitTextToSize(globalComment, pageWidth - 40);
                globalLines.forEach(line => {
                    if (y > pageHeight - 20) {
                        pdf.addPage();
                        y = 20;
                    }
                    pdf.text(line, 20, y);
                    y += 5;
                });

                // Asignaturas individuales
                for (let index = 0; index < state.statistics.length; index++) {
                    const stat = state.statistics[index];
                    
                    if (y > pageHeight - 100) {
                        pdf.addPage();
                        y = 20;
                    } else {
                        y += 10;
                    }

                    pdf.setFontSize(12);
                    pdf.setTextColor(99, 102, 241);
                    pdf.text(`${index + 1}. ${stat.subject}`, 20, y);
                    y += 8;

                    if (stat.alert) {
                        pdf.setTextColor(239, 68, 68);
                        pdf.setFontSize(9);
                        pdf.text(`ALERTA: Mas del 30% de suspensos (${stat.failPercentage}%)`, 20, y);
                        y += 6;
                    }

                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`Aprobados: ${stat.passPercentage}% | Suspensos: ${stat.failPercentage}%`, 20, y);
                    y += 8;

                    // Gr√°ficas de la asignatura
                    const pieCanvas = document.getElementById(`pieChart${index}`);
                    const barCanvas = document.getElementById(`barChart${index}`);
                    
                    if (pieCanvas) {
                        const pieImg = pieCanvas.toDataURL('image/png');
                        pdf.addImage(pieImg, 'PNG', 20, y, 70, 52);
                    }
                    
                    if (barCanvas) {
                        const barImg = barCanvas.toDataURL('image/png');
                        pdf.addImage(barImg, 'PNG', 100, y, 70, 52);
                    }
                    
                    y += 58;

                    pdf.text('Distribucion:', 20, y);
                    y += 5;
                    grades.forEach(grade => {
                        if (y > pageHeight - 20) {
                            pdf.addPage();
                            y = 20;
                        }
                        pdf.text(`  ${grade}: ${stat.gradeDistribution[grade]} alumnos (${stat.gradePercentages[grade]}%)`, 20, y);
                        y += 4;
                    });
                    y += 5;

                    const comment = cleanText(stat.comment);
                    const commentLines = pdf.splitTextToSize(comment, pageWidth - 40);
                    commentLines.forEach(line => {
                        if (y > pageHeight - 20) {
                            pdf.addPage();
                            y = 20;
                        }
                        pdf.text(line, 20, y);
                        y += 4;
                    });
                }

                pdf.save(`Informe_Graficas_${state.stage}_${state.selectedCourse}_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar PDF con gr√°ficas');
            }
        }

        function downloadPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                pdf.setFontSize(18);
                pdf.setTextColor(99, 102, 241);
                pdf.text('INFORME DE ANALISIS DE ACTAS', pageWidth / 2, 20, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`${state.stage === 'infantil' ? 'Infantil' : 'Primaria'} - ${state.selectedCourse}`, pageWidth / 2, 28, { align: 'center' });
                pdf.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, pageWidth / 2, 35, { align: 'center' });
                
                let y = 48;

                pdf.setFontSize(14);
                pdf.setTextColor(99, 102, 241);
                pdf.text('RESUMEN GENERAL', 20, y);
                y += 8;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Total de alumnos: ${state.totalStudents}`, 20, y);
                y += 6;
                pdf.text(`Asignaturas analizadas: ${state.statistics.length}`, 20, y);
                y += 6;
                pdf.text(`Alertas detectadas: ${state.statistics.filter(s => s.alert).length}`, 20, y);
                y += 10;

                pdf.setFontSize(14);
                pdf.setTextColor(99, 102, 241);
                pdf.text('ESTADISTICAS GLOBALES', 20, y);
                y += 8;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Aprobados: ${state.globalStats.passPercentage}%`, 20, y);
                y += 6;
                pdf.text(`Suspensos: ${state.globalStats.failPercentage}%`, 20, y);
                y += 8;

                const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
                pdf.text('Distribucion por calificacion:', 20, y);
                y += 6;
                grades.forEach(grade => {
                    pdf.text(`  ${grade}: ${state.globalStats.gradeDistribution[grade]} (${state.globalStats.gradePercentages[grade]}%)`, 20, y);
                    y += 5;
                });
                y += 5;

                const globalComment = cleanText(state.globalStats.comment);
                const globalLines = pdf.splitTextToSize(globalComment, pageWidth - 40);
                globalLines.forEach(line => {
                    if (y > pageHeight - 20) {
                        pdf.addPage();
                        y = 20;
                    }
                    pdf.text(line, 20, y);
                    y += 5;
                });
                y += 10;

                state.statistics.forEach((stat, index) => {
                    if (y > pageHeight - 70) {
                        pdf.addPage();
                        y = 20;
                    }

                    pdf.setFontSize(12);
                    pdf.setTextColor(99, 102, 241);
                    pdf.text(`${index + 1}. ${stat.subject}`, 20, y);
                    y += 8;

                    if (stat.alert) {
                        pdf.setTextColor(239, 68, 68);
                        pdf.setFontSize(9);
                        pdf.text(`ALERTA: Mas del 30% de suspensos (${stat.failPercentage}%)`, 20, y);
                        y += 6;
                    }

                    pdf.setFontSize(9);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`Aprobados: ${stat.passPercentage}% | Suspensos: ${stat.failPercentage}%`, 20, y);
                    y += 6;

                    pdf.text('Distribucion:', 20, y);
                    y += 5;
                    grades.forEach(grade => {
                        pdf.text(`  ${grade}: ${stat.gradeDistribution[grade]} alumnos (${stat.gradePercentages[grade]}%)`, 20, y);
                        y += 4;
                    });
                    y += 5;

                    const comment = cleanText(stat.comment);
                    const commentLines = pdf.splitTextToSize(comment, pageWidth - 40);
                    commentLines.forEach(line => {
                        if (y > pageHeight - 20) {
                            pdf.addPage();
                            y = 20;
                        }
                        pdf.text(line, 20, y);
                        y += 4;
                    });

                    y += 8;
                });

                pdf.save(`Informe_${state.stage}_${state.selectedCourse}_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar PDF');
            }
        }

        function downloadExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                const resumenData = [
                    ['INFORME DE ANALISIS DE ACTAS'],
                    [`${state.stage === 'infantil' ? 'Infantil' : 'Primaria'} - ${state.selectedCourse}`],
                    [`Fecha: ${new Date().toLocaleDateString('es-ES')}`],
                    [],
                    ['RESUMEN GENERAL'],
                    ['Total de alumnos', state.totalStudents],
                    ['Asignaturas analizadas', state.statistics.length],
                    ['Alertas detectadas', state.statistics.filter(s => s.alert).length],
                    [],
                    ['ESTADISTICAS GLOBALES'],
                    ['Aprobados (%)', state.globalStats.passPercentage],
                    ['Suspensos (%)', state.globalStats.failPercentage],
                    [],
                    ['DISTRIBUCION GLOBAL']
                ];

                const grades = state.stage === 'infantil' ? infantilGrades : primariaGrades;
                grades.forEach(grade => {
                    resumenData.push([
                        grade,
                        state.globalStats.gradeDistribution[grade],
                        `${state.globalStats.gradePercentages[grade]}%`
                    ]);
                });

                const wsResumen = XLSX.utils.aoa_to_sheet(resumenData);
                XLSX.utils.book_append_sheet(wb, wsResumen, 'Resumen');

                const detalleData = [
                    ['Asignatura', 'Aprobados (%)', 'Suspensos (%)', ...grades.map(g => `${g} (alumnos)`), ...grades.map(g => `${g} (%)`),'Alerta']
                ];

                state.statistics.forEach(stat => {
                    const row = [
                        stat.subject,
                        stat.passPercentage,
                        stat.failPercentage,
                        ...grades.map(g => stat.gradeDistribution[g]),
                        ...grades.map(g => stat.gradePercentages[g]),
                        stat.alert ? 'SI' : 'NO'
                    ];
                    detalleData.push(row);
                });

                const wsDetalle = XLSX.utils.aoa_to_sheet(detalleData);
                XLSX.utils.book_append_sheet(wb, wsDetalle, 'Detalle Asignaturas');

                const comentariosData = [
                    ['ANALISIS GLOBAL'],
                    [cleanText(state.globalStats.comment)],
                    [],
                    ['COMENTARIOS POR ASIGNATURA']
                ];

                state.statistics.forEach(stat => {
                    comentariosData.push([]);
                    comentariosData.push([stat.subject]);
                    comentariosData.push([cleanText(stat.comment)]);
                });

                const wsComentarios = XLSX.utils.aoa_to_sheet(comentariosData);
                XLSX.utils.book_append_sheet(wb, wsComentarios, 'Comentarios');

                XLSX.writeFile(wb, `Informe_${state.stage}_${state.selectedCourse}_${new Date().toISOString().split('T')[0]}.xlsx`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar Excel');
            }
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .catch(err => console.log('SW Error:', err));
            });
        }

        render();
    </script>
</body>
</html>
